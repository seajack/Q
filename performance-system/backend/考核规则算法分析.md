# 考核规则关系类型算法分析

## 📋 **关系类型定义**

### 1. **上级评下级 (superior)**
**算法逻辑**:
- 遍历所有员工，找到有直接上级的员工
- 检查上级是否存在于本地员工库中
- 验证是否允许跨部门/跨单位评价
- 创建上级对下级的考核任务

**核心代码**:
```python
def _generate_superior_tasks(self) -> int:
    for org_emp in self.org_employees_data:
        if org_emp.get('supervisor'):  # 有直接上级
            supervisor_org = self.org_employee_map.get(org_emp['supervisor'])
            if supervisor_org and self._is_evaluation_allowed(supervisor_org, org_emp):
                # 创建考核任务
```

### 2. **同级互评 (peer)**
**算法逻辑**:
- 根据评价范围（部门/单位/公司）查找同级同事
- 同级判断标准：同一上级或职位级别相近
- 限制评价人数（max_evaluators_per_relation）
- 排除自己和上级

**核心代码**:
```python
def _find_peers(self, org_emp):
    if self.rule.evaluation_scope == 'department':
        # 同部门同级：同一上级
        peers = [emp for emp in self.org_employees_data 
                if emp['department'] == org_emp['department'] 
                and emp.get('supervisor') == org_emp.get('supervisor')]
    elif self.rule.evaluation_scope == 'company':
        # 全公司同级：职位级别相近
        peers = [emp for emp in self.org_employees_data 
                if abs(emp.get('position_level', 0) - org_emp.get('position_level', 0)) <= self.rule.position_level_diff_limit]
```

### 3. **下级评上级 (subordinate)**
**算法逻辑**:
- 遍历所有员工，找到有直接下属的员工
- 限制评价人数
- 验证评价权限

**核心代码**:
```python
def _generate_subordinate_tasks(self) -> int:
    for org_emp in self.org_employees_data:
        subordinates = [emp for emp in self.org_employees_data 
                       if emp.get('supervisor') == org_emp['id']]
        selected_subordinates = subordinates[:max_evaluators]
```

### 4. **自评 (self)**
**算法逻辑**:
- 检查规则是否允许自评 (allow_self_evaluation)
- 为每个员工创建自评任务

**核心代码**:
```python
def _generate_self_tasks(self) -> int:
    if not self.rule.allow_self_evaluation:
        return 0
    for org_emp in self.org_employees_data:
        # 创建员工对自己的评价任务
```

### 5. **跨部门上级 (cross_superior)**
**算法逻辑**:
- 需要允许跨部门 (allow_cross_department=True)
- 识别跨部门的上级关系
- 目前实现较简化

### 6. **跨部门同级 (cross_peer)**
**算法逻辑**:
- 需要允许跨部门 (allow_cross_department=True)
- 识别跨部门的同级关系
- 目前实现较简化

### 7. **自定义关系 (custom)**
**算法逻辑**:
- 通过手动分配 (ManualEvaluationAssignment) 实现
- 支持完全自定义的评价关系

## 🏢 **职级体系定义**

### **管理层级分类**
```python
MANAGEMENT_LEVEL_CHOICES = [
    ('senior', '高层'),
    ('middle', '中层'), 
    ('junior', '基层'),
]
```

### **职位级别体系（数字越大级别越高）**
```python
POSITION_LEVEL_CHOICES = [
    (13, '高层正职'),    # 董事长、总经理
    (12, '高层副职'),    # 副总经理
    (11, '高层助理'),    # 总经理助理
    (9, '中层正职'),     # 部门经理
    (8, '中层副职'),     # 副经理
    (7, '中层助理'),     # 经理助理
    (4, '基层正职'),     # 主管
    (3, '基层副职'),     # 副主管
    (2, '基层助理'),     # 助理
    (1, '员工'),         # 普通员工
]
```

## ⚖️ **权重分配算法**

### **基础权重配置**
```python
base_weights = {
    'superior': 0.60,     # 上级考核权重60%
    'peer': 0.25,         # 同级互评权重25%
    'subordinate': 0.15,  # 下级评价权重15%
}
```

### **职位级别权重调整**
```python
level_multipliers = {
    1: 1.0,  # 初级
    2: 1.0,  # 初级
    3: 1.2,  # 中级
    4: 1.2,  # 中级
    5: 1.5,  # 高级
    6: 1.5,  # 高级
    7: 2.0,  # 管理级
    8: 2.0,  # 管理级
}
```

## 🔍 **评价权限验证**

### **跨部门限制**
```python
if not self.rule.allow_cross_department and evaluator_org['department'] != evaluatee_org['department']:
    return False
```

### **跨单位限制**
```python
if not self.rule.allow_cross_unit and evaluator_org.get('unit_id') != evaluatee_org.get('unit_id'):
    return False
```

### **职位级别差距限制**
```python
if abs(evaluator_level - evaluatee_level) > self.rule.position_level_diff_limit:
    return False
```

## 📊 **规则配置示例**

### **360度全方位评价**
```python
{
    'relation_types': ['superior', 'peer', 'subordinate', 'self'],
    'relation_weights': {
        'superior': 0.5,
        'peer': 0.3,
        'subordinate': 0.1,
        'self': 0.1
    },
    'allow_cross_department': False,
    'position_level_diff_limit': 2
}
```

### **本部门上级评下级**
```python
{
    'relation_types': ['superior'],
    'relation_weights': {'superior': 1.0},
    'allow_cross_department': False,
    'position_level_diff_limit': 2
}
```

## 🎯 **算法特点**

1. **灵活性**: 支持多种关系类型组合
2. **可配置性**: 权重、范围、限制都可自定义
3. **层级感知**: 基于职级体系的智能匹配
4. **权限控制**: 严格的跨部门/跨单位限制
5. **人数控制**: 每种关系类型的评价人数限制

## 🔧 **扩展性**

- 支持自定义关系类型
- 支持复杂的权重计算
- 支持多维度评价范围
- 支持手动分配覆盖
