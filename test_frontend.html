<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç»„ç»‡æ¶æ„APIæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">ğŸ§ª æ™ºèƒ½ç»„ç»‡æ¶æ„APIæµ‹è¯•</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ§åˆ¶å°</h2>
            <div class="flex gap-4 mb-4">
                <button onclick="testAllAPIs()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•
                </button>
                <button onclick="clearResults()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ—‘ï¸ æ¸…é™¤ç»“æœ
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="testAPI('/api/intelligence/analysis/', 'ç»„ç»‡åˆ†æ')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ“Š æµ‹è¯•ç»„ç»‡åˆ†æ
                </button>
                <button onclick="testAPI('/api/intelligence/metrics/', 'ç»„ç»‡æŒ‡æ ‡')" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ“ˆ æµ‹è¯•ç»„ç»‡æŒ‡æ ‡
                </button>
                <button onclick="testAPI('/api/intelligence/suggestions/', 'ä¼˜åŒ–å»ºè®®')" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ’¡ æµ‹è¯•ä¼˜åŒ–å»ºè®®
                </button>
                <button onclick="testRefreshAPI()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    ğŸ”„ æµ‹è¯•åˆ·æ–°åˆ†æ
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•ç»“æœ</h2>
            <div id="testResults" class="space-y-2">
                <div class="test-result loading">
                    ğŸ“ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ•°æ®é¢„è§ˆ</h2>
            <div id="dataPreview" class="bg-gray-50 p-4 rounded border overflow-auto max-h-96">
                <pre id="jsonData" class="text-sm">æš‚æ— æ•°æ®</pre>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8001';
        let testCount = 0;
        let passedCount = 0;
        
        function addResult(message, isSuccess, data = null) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML = `
                <strong>[${timestamp}]</strong> ${message}
                ${data ? `<details class="mt-2"><summary class="cursor-pointer">æŸ¥çœ‹æ•°æ®</summary><pre class="mt-2 text-xs bg-white p-2 rounded">${JSON.stringify(data, null, 2)}</pre></details>` : ''}
            `;
            
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            testCount++;
            if (isSuccess) passedCount++;
            
            updateTestStats();
        }
        
        function updateTestStats() {
            const successRate = testCount > 0 ? ((passedCount / testCount) * 100).toFixed(1) : 0;
            document.title = `æµ‹è¯•è¿›åº¦: ${passedCount}/${testCount} (${successRate}%)`;
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '<div class="test-result loading">ğŸ“ æµ‹è¯•ç»“æœå·²æ¸…é™¤ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•...</div>';
            document.getElementById('jsonData').textContent = 'æš‚æ— æ•°æ®';
            testCount = 0;
            passedCount = 0;
            updateTestStats();
        }
        
        async function testAPI(endpoint, name) {
            addResult(`ğŸ”„ æ­£åœ¨æµ‹è¯• ${name}...`, true);
            
            try {
                const response = await fetch(BASE_URL + endpoint, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        addResult(`âœ… ${name} æµ‹è¯•æˆåŠŸ`, true, data);
                        
                        // æ›´æ–°æ•°æ®é¢„è§ˆ
                        document.getElementById('jsonData').textContent = JSON.stringify(data, null, 2);
                    } else {
                        addResult(`âš ï¸ ${name} APIè¿”å›å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, false, data);
                    }
                } else {
                    addResult(`âŒ ${name} HTTPé”™è¯¯: ${response.status} ${response.statusText}`, false);
                }
            } catch (error) {
                addResult(`âŒ ${name} ç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }
        
        async function testRefreshAPI() {
            addResult(`ğŸ”„ æ­£åœ¨æµ‹è¯•åˆ·æ–°åˆ†æ...`, true);
            
            try {
                const response = await fetch(BASE_URL + '/api/intelligence/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        addResult(`âœ… åˆ·æ–°åˆ†ææµ‹è¯•æˆåŠŸ`, true, data);
                    } else {
                        addResult(`âš ï¸ åˆ·æ–°åˆ†æå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, false, data);
                    }
                } else {
                    addResult(`âŒ åˆ·æ–°åˆ†æHTTPé”™è¯¯: ${response.status} ${response.statusText}`, false);
                }
            } catch (error) {
                addResult(`âŒ åˆ·æ–°åˆ†æç½‘ç»œé”™è¯¯: ${error.message}`, false);
            }
        }
        
        async function testAllAPIs() {
            clearResults();
            addResult(`ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´APIæµ‹è¯•å¥—ä»¶...`, true);
            
            const tests = [
                ['/api/intelligence/analysis/', 'ç»„ç»‡åˆ†æ'],
                ['/api/intelligence/metrics/', 'ç»„ç»‡æŒ‡æ ‡'],
                ['/api/intelligence/suggestions/', 'ä¼˜åŒ–å»ºè®®'],
                ['/api/intelligence/history/', 'åˆ†æå†å²'],
                ['/api/intelligence/benchmark/', 'åŸºå‡†å¯¹æ¯”']
            ];
            
            for (const [endpoint, name] of tests) {
                await testAPI(endpoint, name);
                await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿ500ms
            }
            
            // æµ‹è¯•POSTæ¥å£
            await testRefreshAPI();
            
            addResult(`ğŸ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼é€šè¿‡ç‡: ${passedCount}/${testCount} (${((passedCount/testCount)*100).toFixed(1)}%)`, passedCount === testCount);
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            addResult(`ğŸŒ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œåç«¯åœ°å€: ${BASE_URL}`, true);
            
            // æµ‹è¯•åŸºç¡€è¿æ¥
            fetch(BASE_URL + '/api/')
                .then(response => {
                    if (response.ok) {
                        addResult(`âœ… åç«¯æœåŠ¡è¿æ¥æ­£å¸¸`, true);
                    } else {
                        addResult(`âš ï¸ åç«¯æœåŠ¡å“åº”å¼‚å¸¸: ${response.status}`, false);
                    }
                })
                .catch(error => {
                    addResult(`âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡: ${error.message}`, false);
                    addResult(`ğŸ’¡ è¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ ${BASE_URL}`, false);
                });
        };
    </script>
</body>
</html>
