# ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆå­—æ®µæ‰©å±•æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### å½“å‰æŒ‘æˆ˜
1. **æœªçŸ¥å­—æ®µé—®é¢˜**ï¼šç¬¬ä¸‰æ–¹ç³»ç»Ÿå¯èƒ½æœ‰æˆ‘ä»¬ä¸çŸ¥é“çš„å­—æ®µ
2. **å­—æ®µç±»å‹å·®å¼‚**ï¼šä¸åŒç³»ç»Ÿçš„å­—æ®µç±»å‹å¯èƒ½ä¸åŒ¹é…
3. **æ•°æ®åŒæ­¥å†²çª**ï¼šå¤šç³»ç»Ÿé—´çš„æ•°æ®åŒæ­¥å¯èƒ½äº§ç”Ÿå†²çª
4. **æ‰©å±•æ€§é™åˆ¶**ï¼šç¡¬ç¼–ç å­—æ®µéš¾ä»¥é€‚åº”æ–°éœ€æ±‚

### è§£å†³æ–¹æ¡ˆ

## ğŸ”§ æ–¹æ¡ˆä¸€ï¼šé¢„ç•™æ‰©å±•å­—æ®µ

### 1.1 åœ¨ç°æœ‰æ¨¡å‹ä¸­æ·»åŠ æ‰©å±•å­—æ®µ

```python
# æ‰©å±•åçš„æ¨¡å‹è®¾è®¡
class Department(models.Model):
    """éƒ¨é—¨æ¨¡å‹ - æ‰©å±•ç‰ˆ"""
    # åŸæœ‰å­—æ®µ...
    name = models.CharField('éƒ¨é—¨åç§°', max_length=100)
    code = models.CharField('éƒ¨é—¨ç¼–ç ', max_length=50, unique=True)
    # ... å…¶ä»–åŸæœ‰å­—æ®µ
    
    # æ–°å¢æ‰©å±•å­—æ®µ
    external_id = models.CharField('å¤–éƒ¨ç³»ç»ŸID', max_length=100, blank=True, null=True)
    external_source = models.CharField('å¤–éƒ¨ç³»ç»Ÿæ¥æº', max_length=50, blank=True, null=True)
    custom_fields = models.JSONField('è‡ªå®šä¹‰å­—æ®µ', default=dict, blank=True)
    sync_status = models.CharField('åŒæ­¥çŠ¶æ€', max_length=20, choices=[
        ('pending', 'å¾…åŒæ­¥'),
        ('synced', 'å·²åŒæ­¥'),
        ('conflict', 'å†²çª'),
        ('error', 'é”™è¯¯')
    ], default='pending')
    last_sync_at = models.DateTimeField('æœ€ååŒæ­¥æ—¶é—´', null=True, blank=True)
    sync_metadata = models.JSONField('åŒæ­¥å…ƒæ•°æ®', default=dict, blank=True)

class Position(models.Model):
    """èŒä½æ¨¡å‹ - æ‰©å±•ç‰ˆ"""
    # åŸæœ‰å­—æ®µ...
    name = models.CharField('èŒä½åç§°', max_length=100)
    code = models.CharField('èŒä½ç¼–ç ', max_length=50, unique=True)
    # ... å…¶ä»–åŸæœ‰å­—æ®µ
    
    # æ–°å¢æ‰©å±•å­—æ®µ
    external_id = models.CharField('å¤–éƒ¨ç³»ç»ŸID', max_length=100, blank=True, null=True)
    external_source = models.CharField('å¤–éƒ¨ç³»ç»Ÿæ¥æº', max_length=50, blank=True, null=True)
    custom_fields = models.JSONField('è‡ªå®šä¹‰å­—æ®µ', default=dict, blank=True)
    sync_status = models.CharField('åŒæ­¥çŠ¶æ€', max_length=20, choices=[
        ('pending', 'å¾…åŒæ­¥'),
        ('synced', 'å·²åŒæ­¥'),
        ('conflict', 'å†²çª'),
        ('error', 'é”™è¯¯')
    ], default='pending')
    last_sync_at = models.DateTimeField('æœ€ååŒæ­¥æ—¶é—´', null=True, blank=True)
    sync_metadata = models.JSONField('åŒæ­¥å…ƒæ•°æ®', default=dict, blank=True)

class Employee(models.Model):
    """å‘˜å·¥æ¨¡å‹ - æ‰©å±•ç‰ˆ"""
    # åŸæœ‰å­—æ®µ...
    user = models.OneToOneField(User, verbose_name='ç”¨æˆ·è´¦å·', on_delete=models.CASCADE, related_name='employee')
    employee_id = models.CharField('å‘˜å·¥å·', max_length=20, unique=True)
    name = models.CharField('å§“å', max_length=50)
    # ... å…¶ä»–åŸæœ‰å­—æ®µ
    
    # æ–°å¢æ‰©å±•å­—æ®µ
    external_id = models.CharField('å¤–éƒ¨ç³»ç»ŸID', max_length=100, blank=True, null=True)
    external_source = models.CharField('å¤–éƒ¨ç³»ç»Ÿæ¥æº', max_length=50, blank=True, null=True)
    custom_fields = models.JSONField('è‡ªå®šä¹‰å­—æ®µ', default=dict, blank=True)
    sync_status = models.CharField('åŒæ­¥çŠ¶æ€', max_length=20, choices=[
        ('pending', 'å¾…åŒæ­¥'),
        ('synced', 'å·²åŒæ­¥'),
        ('conflict', 'å†²çª'),
        ('error', 'é”™è¯¯')
    ], default='pending')
    last_sync_at = models.DateTimeField('æœ€ååŒæ­¥æ—¶é—´', null=True, blank=True)
    sync_metadata = models.JSONField('åŒæ­¥å…ƒæ•°æ®', default=dict, blank=True)
```

## ğŸ”§ æ–¹æ¡ˆäºŒï¼šåŠ¨æ€å­—æ®µç®¡ç†

### 2.1 åˆ›å»ºåŠ¨æ€å­—æ®µç®¡ç†æ¨¡å‹

```python
class DynamicField(models.Model):
    """åŠ¨æ€å­—æ®µå®šä¹‰æ¨¡å‹"""
    FIELD_TYPE_CHOICES = [
        ('string', 'å­—ç¬¦ä¸²'),
        ('integer', 'æ•´æ•°'),
        ('decimal', 'å°æ•°'),
        ('boolean', 'å¸ƒå°”å€¼'),
        ('date', 'æ—¥æœŸ'),
        ('datetime', 'æ—¥æœŸæ—¶é—´'),
        ('text', 'é•¿æ–‡æœ¬'),
        ('json', 'JSONå¯¹è±¡'),
        ('choice', 'é€‰æ‹©é¡¹'),
    ]
    
    model_name = models.CharField('æ¨¡å‹åç§°', max_length=50)  # Department, Position, Employee
    field_name = models.CharField('å­—æ®µåç§°', max_length=100)
    field_type = models.CharField('å­—æ®µç±»å‹', max_length=20, choices=FIELD_TYPE_CHOICES)
    field_label = models.CharField('å­—æ®µæ ‡ç­¾', max_length=100)
    field_description = models.TextField('å­—æ®µæè¿°', blank=True)
    is_required = models.BooleanField('æ˜¯å¦å¿…éœ€', default=False)
    default_value = models.TextField('é»˜è®¤å€¼', blank=True)
    choices = models.JSONField('é€‰æ‹©é¡¹', default=list, blank=True)  # ç”¨äºchoiceç±»å‹
    validation_rules = models.JSONField('éªŒè¯è§„åˆ™', default=dict, blank=True)
    is_active = models.BooleanField('æ˜¯å¦å¯ç”¨', default=True)
    external_source = models.CharField('å¤–éƒ¨ç³»ç»Ÿæ¥æº', max_length=50, blank=True, null=True)
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        verbose_name = 'åŠ¨æ€å­—æ®µ'
        verbose_name_plural = 'åŠ¨æ€å­—æ®µ'
        unique_together = ['model_name', 'field_name']
        ordering = ['model_name', 'field_name']
    
    def __str__(self):
        return f"{self.model_name}.{self.field_name}"

class DynamicFieldValue(models.Model):
    """åŠ¨æ€å­—æ®µå€¼æ¨¡å‹"""
    dynamic_field = models.ForeignKey(DynamicField, on_delete=models.CASCADE, related_name='values')
    object_id = models.PositiveIntegerField('å¯¹è±¡ID')
    field_value = models.TextField('å­—æ®µå€¼')
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        verbose_name = 'åŠ¨æ€å­—æ®µå€¼'
        verbose_name_plural = 'åŠ¨æ€å­—æ®µå€¼'
        unique_together = ['dynamic_field', 'object_id']
        ordering = ['dynamic_field', 'object_id']
    
    def __str__(self):
        return f"{self.dynamic_field.field_name}: {self.field_value}"
```

### 2.2 åŠ¨æ€å­—æ®µç®¡ç†å™¨

```python
class DynamicFieldManager:
    """åŠ¨æ€å­—æ®µç®¡ç†å™¨"""
    
    def __init__(self, model_name):
        self.model_name = model_name
        self.fields = self._load_fields()
    
    def _load_fields(self):
        """åŠ è½½åŠ¨æ€å­—æ®µå®šä¹‰"""
        return DynamicField.objects.filter(
            model_name=self.model_name,
            is_active=True
        ).order_by('field_name')
    
    def get_field_value(self, object_id, field_name):
        """è·å–åŠ¨æ€å­—æ®µå€¼"""
        try:
            field = self.fields.get(field_name=field_name)
            value_obj = DynamicFieldValue.objects.get(
                dynamic_field=field,
                object_id=object_id
            )
            return self._convert_value(value_obj.field_value, field.field_type)
        except (DynamicField.DoesNotExist, DynamicFieldValue.DoesNotExist):
            return None
    
    def set_field_value(self, object_id, field_name, value):
        """è®¾ç½®åŠ¨æ€å­—æ®µå€¼"""
        try:
            field = self.fields.get(field_name=field_name)
            value_str = self._convert_to_string(value, field.field_type)
            
            value_obj, created = DynamicFieldValue.objects.get_or_create(
                dynamic_field=field,
                object_id=object_id,
                defaults={'field_value': value_str}
            )
            if not created:
                value_obj.field_value = value_str
                value_obj.save()
            return True
        except DynamicField.DoesNotExist:
            return False
    
    def _convert_value(self, value_str, field_type):
        """å°†å­—ç¬¦ä¸²å€¼è½¬æ¢ä¸ºå¯¹åº”ç±»å‹"""
        if not value_str:
            return None
            
        if field_type == 'string':
            return value_str
        elif field_type == 'integer':
            return int(value_str)
        elif field_type == 'decimal':
            from decimal import Decimal
            return Decimal(value_str)
        elif field_type == 'boolean':
            return value_str.lower() in ('true', '1', 'yes')
        elif field_type == 'json':
            import json
            return json.loads(value_str)
        else:
            return value_str
    
    def _convert_to_string(self, value, field_type):
        """å°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²å­˜å‚¨"""
        if value is None:
            return ''
        
        if field_type == 'json':
            import json
            return json.dumps(value, ensure_ascii=False)
        else:
            return str(value)
```

## ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šå¤–éƒ¨ç³»ç»Ÿæ˜ å°„

### 3.1 å¤–éƒ¨ç³»ç»Ÿé…ç½®æ¨¡å‹

```python
class ExternalSystem(models.Model):
    """å¤–éƒ¨ç³»ç»Ÿé…ç½®æ¨¡å‹"""
    name = models.CharField('ç³»ç»Ÿåç§°', max_length=100)
    system_type = models.CharField('ç³»ç»Ÿç±»å‹', max_length=50)  # HR, OA, Financeç­‰
    api_endpoint = models.URLField('APIç«¯ç‚¹')
    auth_type = models.CharField('è®¤è¯ç±»å‹', max_length=20, choices=[
        ('basic', 'åŸºç¡€è®¤è¯'),
        ('token', 'ä»¤ç‰Œè®¤è¯'),
        ('oauth', 'OAuthè®¤è¯'),
        ('api_key', 'APIå¯†é’¥'),
    ])
    auth_config = models.JSONField('è®¤è¯é…ç½®', default=dict)
    sync_config = models.JSONField('åŒæ­¥é…ç½®', default=dict)
    is_active = models.BooleanField('æ˜¯å¦å¯ç”¨', default=True)
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        verbose_name = 'å¤–éƒ¨ç³»ç»Ÿ'
        verbose_name_plural = 'å¤–éƒ¨ç³»ç»Ÿ'
        ordering = ['name']
    
    def __str__(self):
        return self.name

class FieldMapping(models.Model):
    """å­—æ®µæ˜ å°„æ¨¡å‹"""
    external_system = models.ForeignKey(ExternalSystem, on_delete=models.CASCADE, related_name='mappings')
    local_model = models.CharField('æœ¬åœ°æ¨¡å‹', max_length=50)  # Department, Position, Employee
    local_field = models.CharField('æœ¬åœ°å­—æ®µ', max_length=100)
    external_field = models.CharField('å¤–éƒ¨å­—æ®µ', max_length=100)
    field_type = models.CharField('å­—æ®µç±»å‹', max_length=20)
    is_required = models.BooleanField('æ˜¯å¦å¿…éœ€', default=False)
    default_value = models.TextField('é»˜è®¤å€¼', blank=True)
    transformation_rule = models.JSONField('è½¬æ¢è§„åˆ™', default=dict, blank=True)
    is_active = models.BooleanField('æ˜¯å¦å¯ç”¨', default=True)
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        verbose_name = 'å­—æ®µæ˜ å°„'
        verbose_name_plural = 'å­—æ®µæ˜ å°„'
        unique_together = ['external_system', 'local_model', 'local_field']
        ordering = ['external_system', 'local_model', 'local_field']
    
    def __str__(self):
        return f"{self.external_system.name}: {self.local_model}.{self.local_field} -> {self.external_field}"
```

### 3.2 æ•°æ®åŒæ­¥æœåŠ¡

```python
class DataSyncService:
    """æ•°æ®åŒæ­¥æœåŠ¡"""
    
    def __init__(self, external_system):
        self.external_system = external_system
        self.mappings = self._load_mappings()
    
    def _load_mappings(self):
        """åŠ è½½å­—æ®µæ˜ å°„"""
        return FieldMapping.objects.filter(
            external_system=self.external_system,
            is_active=True
        ).select_related('external_system')
    
    def sync_to_external(self, local_object, model_name):
        """åŒæ­¥æ•°æ®åˆ°å¤–éƒ¨ç³»ç»Ÿ"""
        try:
            # æ„å»ºå¤–éƒ¨ç³»ç»Ÿæ•°æ®
            external_data = self._build_external_data(local_object, model_name)
            
            # è°ƒç”¨å¤–éƒ¨ç³»ç»ŸAPI
            response = self._call_external_api(external_data)
            
            # æ›´æ–°åŒæ­¥çŠ¶æ€
            self._update_sync_status(local_object, 'synced', response)
            
            return True
        except Exception as e:
            # è®°å½•åŒæ­¥é”™è¯¯
            self._update_sync_status(local_object, 'error', {'error': str(e)})
            return False
    
    def sync_from_external(self, external_data, model_name):
        """ä»å¤–éƒ¨ç³»ç»ŸåŒæ­¥æ•°æ®"""
        try:
            # æŸ¥æ‰¾æˆ–åˆ›å»ºæœ¬åœ°å¯¹è±¡
            local_object = self._find_or_create_local_object(external_data, model_name)
            
            # æ›´æ–°æœ¬åœ°å¯¹è±¡æ•°æ®
            self._update_local_object(local_object, external_data, model_name)
            
            # æ›´æ–°åŒæ­¥çŠ¶æ€
            self._update_sync_status(local_object, 'synced', external_data)
            
            return local_object
        except Exception as e:
            # è®°å½•åŒæ­¥é”™è¯¯
            self._log_sync_error(external_data, str(e))
            return None
    
    def _build_external_data(self, local_object, model_name):
        """æ„å»ºå¤–éƒ¨ç³»ç»Ÿæ•°æ®"""
        external_data = {}
        
        for mapping in self.mappings.filter(local_model=model_name):
            local_value = getattr(local_object, mapping.local_field, None)
            
            if local_value is not None:
                # åº”ç”¨è½¬æ¢è§„åˆ™
                transformed_value = self._apply_transformation(
                    local_value, 
                    mapping.transformation_rule
                )
                external_data[mapping.external_field] = transformed_value
        
        return external_data
    
    def _apply_transformation(self, value, rule):
        """åº”ç”¨æ•°æ®è½¬æ¢è§„åˆ™"""
        if not rule:
            return value
        
        # å®ç°å„ç§è½¬æ¢è§„åˆ™
        if rule.get('type') == 'format':
            return value.strftime(rule.get('format', '%Y-%m-%d'))
        elif rule.get('type') == 'mapping':
            return rule.get('mapping', {}).get(str(value), value)
        elif rule.get('type') == 'function':
            # æ‰§è¡Œè‡ªå®šä¹‰è½¬æ¢å‡½æ•°
            return self._execute_transformation_function(value, rule)
        
        return value
```

## ğŸ”§ æ–¹æ¡ˆå››ï¼šAPIé€‚é…å™¨æ¨¡å¼

### 4.1 é€šç”¨APIé€‚é…å™¨

```python
class APIAdapter:
    """é€šç”¨APIé€‚é…å™¨"""
    
    def __init__(self, external_system):
        self.external_system = external_system
        self.client = self._create_client()
    
    def _create_client(self):
        """åˆ›å»ºAPIå®¢æˆ·ç«¯"""
        auth_config = self.external_system.auth_config
        
        if self.external_system.auth_type == 'token':
            return TokenAuthClient(
                base_url=self.external_system.api_endpoint,
                token=auth_config.get('token')
            )
        elif self.external_system.auth_type == 'oauth':
            return OAuthClient(
                base_url=self.external_system.api_endpoint,
                client_id=auth_config.get('client_id'),
                client_secret=auth_config.get('client_secret')
            )
        else:
            return BasicAuthClient(
                base_url=self.external_system.api_endpoint,
                username=auth_config.get('username'),
                password=auth_config.get('password')
            )
    
    def get_employees(self, **filters):
        """è·å–å‘˜å·¥æ•°æ®"""
        return self.client.get('/employees', params=filters)
    
    def get_departments(self, **filters):
        """è·å–éƒ¨é—¨æ•°æ®"""
        return self.client.get('/departments', params=filters)
    
    def get_positions(self, **filters):
        """è·å–èŒä½æ•°æ®"""
        return self.client.get('/positions', params=filters)
    
    def create_employee(self, data):
        """åˆ›å»ºå‘˜å·¥"""
        return self.client.post('/employees', json=data)
    
    def update_employee(self, employee_id, data):
        """æ›´æ–°å‘˜å·¥"""
        return self.client.put(f'/employees/{employee_id}', json=data)
    
    def delete_employee(self, employee_id):
        """åˆ é™¤å‘˜å·¥"""
        return self.client.delete(f'/employees/{employee_id}')

class HRSystemAdapter(APIAdapter):
    """HRç³»ç»Ÿä¸“ç”¨é€‚é…å™¨"""
    
    def get_employees(self, **filters):
        """é‡å†™å‘˜å·¥è·å–é€»è¾‘ï¼Œé€‚é…HRç³»ç»ŸAPI"""
        # HRç³»ç»Ÿå¯èƒ½æœ‰ç‰¹æ®Šçš„APIæ ¼å¼
        hr_filters = self._convert_filters_to_hr_format(filters)
        return self.client.get('/api/v1/employees', params=hr_filters)
    
    def _convert_filters_to_hr_format(self, filters):
        """è½¬æ¢è¿‡æ»¤å™¨æ ¼å¼"""
        hr_filters = {}
        for key, value in filters.items():
            # å®ç°å­—æ®µåæ˜ å°„
            hr_key = self._map_field_name(key)
            hr_filters[hr_key] = value
        return hr_filters
    
    def _map_field_name(self, local_field):
        """å­—æ®µåæ˜ å°„"""
        mapping = {
            'employee_id': 'emp_no',
            'name': 'full_name',
            'department': 'dept_code',
            'position': 'job_title'
        }
        return mapping.get(local_field, local_field)
```

## ğŸ”§ æ–¹æ¡ˆäº”ï¼šé…ç½®é©±åŠ¨çš„å­—æ®µå¤„ç†

### 5.1 å­—æ®µé…ç½®æ¨¡å‹

```python
class FieldConfiguration(models.Model):
    """å­—æ®µé…ç½®æ¨¡å‹"""
    external_system = models.ForeignKey(ExternalSystem, on_delete=models.CASCADE)
    model_name = models.CharField('æ¨¡å‹åç§°', max_length=50)
    field_config = models.JSONField('å­—æ®µé…ç½®', default=dict)
    sync_rules = models.JSONField('åŒæ­¥è§„åˆ™', default=dict)
    conflict_resolution = models.JSONField('å†²çªè§£å†³', default=dict)
    is_active = models.BooleanField('æ˜¯å¦å¯ç”¨', default=True)
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    
    class Meta:
        verbose_name = 'å­—æ®µé…ç½®'
        verbose_name_plural = 'å­—æ®µé…ç½®'
        unique_together = ['external_system', 'model_name']
    
    def __str__(self):
        return f"{self.external_system.name} - {self.model_name}"

# å­—æ®µé…ç½®ç¤ºä¾‹
field_config_example = {
    "employee": {
        "mappings": {
            "employee_id": {"external": "emp_no", "type": "string", "required": True},
            "name": {"external": "full_name", "type": "string", "required": True},
            "email": {"external": "email_address", "type": "email", "required": False},
            "phone": {"external": "mobile_phone", "type": "string", "required": False},
            "department": {"external": "dept_id", "type": "foreign_key", "required": True},
            "position": {"external": "job_title", "type": "string", "required": True},
            "hire_date": {"external": "start_date", "type": "date", "required": True},
            "status": {"external": "employment_status", "type": "choice", "required": True}
        },
        "custom_fields": {
            "social_security_number": {"external": "ssn", "type": "string", "required": False},
            "emergency_contact": {"external": "emergency_contact", "type": "json", "required": False},
            "skills": {"external": "skill_set", "type": "json", "required": False}
        },
        "validation_rules": {
            "employee_id": {"pattern": "^[A-Z0-9]+$", "min_length": 3, "max_length": 20},
            "email": {"pattern": "^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$"},
            "phone": {"pattern": "^1[3-9]\\d{9}$"}
        },
        "transformation_rules": {
            "status": {
                "type": "mapping",
                "mapping": {
                    "active": "åœ¨èŒ",
                    "inactive": "ç¦»èŒ",
                    "on_leave": "ä¼‘å‡"
                }
            },
            "hire_date": {
                "type": "format",
                "format": "%Y-%m-%d"
            }
        }
    }
}
```

### 5.2 é…ç½®é©±åŠ¨çš„åŒæ­¥æœåŠ¡

```python
class ConfigurationDrivenSyncService:
    """é…ç½®é©±åŠ¨çš„åŒæ­¥æœåŠ¡"""
    
    def __init__(self, external_system, model_name):
        self.external_system = external_system
        self.model_name = model_name
        self.config = self._load_configuration()
    
    def _load_configuration(self):
        """åŠ è½½å­—æ®µé…ç½®"""
        try:
            config_obj = FieldConfiguration.objects.get(
                external_system=self.external_system,
                model_name=self.model_name,
                is_active=True
            )
            return config_obj.field_config
        except FieldConfiguration.DoesNotExist:
            return {}
    
    def sync_object(self, local_object, direction='both'):
        """åŒæ­¥å¯¹è±¡æ•°æ®"""
        if direction in ['to_external', 'both']:
            self._sync_to_external(local_object)
        
        if direction in ['from_external', 'both']:
            self._sync_from_external(local_object)
    
    def _sync_to_external(self, local_object):
        """åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿ"""
        external_data = self._build_external_data(local_object)
        
        # åº”ç”¨éªŒè¯è§„åˆ™
        if not self._validate_data(external_data):
            raise ValueError("æ•°æ®éªŒè¯å¤±è´¥")
        
        # è°ƒç”¨å¤–éƒ¨ç³»ç»ŸAPI
        self._call_external_api(external_data)
    
    def _build_external_data(self, local_object):
        """æ„å»ºå¤–éƒ¨ç³»ç»Ÿæ•°æ®"""
        external_data = {}
        mappings = self.config.get('mappings', {})
        custom_fields = self.config.get('custom_fields', {})
        
        # å¤„ç†æ ‡å‡†å­—æ®µæ˜ å°„
        for local_field, mapping in mappings.items():
            value = getattr(local_object, local_field, None)
            if value is not None:
                external_field = mapping['external']
                transformed_value = self._transform_value(value, mapping)
                external_data[external_field] = transformed_value
        
        # å¤„ç†è‡ªå®šä¹‰å­—æ®µ
        if hasattr(local_object, 'custom_fields'):
            custom_data = local_object.custom_fields or {}
            for local_field, mapping in custom_fields.items():
                value = custom_data.get(local_field)
                if value is not None:
                    external_field = mapping['external']
                    transformed_value = self._transform_value(value, mapping)
                    external_data[external_field] = transformed_value
        
        return external_data
    
    def _transform_value(self, value, mapping):
        """è½¬æ¢å­—æ®µå€¼"""
        transformation_rules = self.config.get('transformation_rules', {})
        field_name = mapping.get('external')
        
        if field_name in transformation_rules:
            rule = transformation_rules[field_name]
            return self._apply_transformation_rule(value, rule)
        
        return value
    
    def _apply_transformation_rule(self, value, rule):
        """åº”ç”¨è½¬æ¢è§„åˆ™"""
        rule_type = rule.get('type')
        
        if rule_type == 'mapping':
            return rule.get('mapping', {}).get(str(value), value)
        elif rule_type == 'format':
            if hasattr(value, 'strftime'):
                return value.strftime(rule.get('format', '%Y-%m-%d'))
        elif rule_type == 'function':
            # æ‰§è¡Œè‡ªå®šä¹‰è½¬æ¢å‡½æ•°
            return self._execute_custom_function(value, rule)
        
        return value
```

## ğŸ”§ æ–¹æ¡ˆå…­ï¼šäº‹ä»¶é©±åŠ¨çš„å­—æ®µå¤„ç†

### 6.1 å­—æ®µå˜æ›´äº‹ä»¶æ¨¡å‹

```python
class FieldChangeEvent(models.Model):
    """å­—æ®µå˜æ›´äº‹ä»¶æ¨¡å‹"""
    EVENT_TYPE_CHOICES = [
        ('create', 'åˆ›å»º'),
        ('update', 'æ›´æ–°'),
        ('delete', 'åˆ é™¤'),
        ('sync', 'åŒæ­¥'),
    ]
    
    model_name = models.CharField('æ¨¡å‹åç§°', max_length=50)
    object_id = models.PositiveIntegerField('å¯¹è±¡ID')
    field_name = models.CharField('å­—æ®µåç§°', max_length=100)
    old_value = models.TextField('æ—§å€¼', blank=True)
    new_value = models.TextField('æ–°å€¼', blank=True)
    event_type = models.CharField('äº‹ä»¶ç±»å‹', max_length=20, choices=EVENT_TYPE_CHOICES)
    external_system = models.ForeignKey(ExternalSystem, on_delete=models.CASCADE, null=True, blank=True)
    sync_status = models.CharField('åŒæ­¥çŠ¶æ€', max_length=20, choices=[
        ('pending', 'å¾…åŒæ­¥'),
        ('synced', 'å·²åŒæ­¥'),
        ('failed', 'åŒæ­¥å¤±è´¥'),
    ], default='pending')
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    processed_at = models.DateTimeField('å¤„ç†æ—¶é—´', null=True, blank=True)
    
    class Meta:
        verbose_name = 'å­—æ®µå˜æ›´äº‹ä»¶'
        verbose_name_plural = 'å­—æ®µå˜æ›´äº‹ä»¶'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.model_name}.{self.field_name} - {self.event_type}"

class EventProcessor:
    """äº‹ä»¶å¤„ç†å™¨"""
    
    def __init__(self):
        self.processors = {
            'create': self._process_create_event,
            'update': self._process_update_event,
            'delete': self._process_delete_event,
            'sync': self._process_sync_event,
        }
    
    def process_event(self, event):
        """å¤„ç†äº‹ä»¶"""
        processor = self.processors.get(event.event_type)
        if processor:
            return processor(event)
        return False
    
    def _process_create_event(self, event):
        """å¤„ç†åˆ›å»ºäº‹ä»¶"""
        # åŒæ­¥æ–°åˆ›å»ºçš„å¯¹è±¡åˆ°å¤–éƒ¨ç³»ç»Ÿ
        return self._sync_object_to_external(event)
    
    def _process_update_event(self, event):
        """å¤„ç†æ›´æ–°äº‹ä»¶"""
        # åŒæ­¥æ›´æ–°çš„å­—æ®µåˆ°å¤–éƒ¨ç³»ç»Ÿ
        return self._sync_field_to_external(event)
    
    def _process_delete_event(self, event):
        """å¤„ç†åˆ é™¤äº‹ä»¶"""
        # ä»å¤–éƒ¨ç³»ç»Ÿåˆ é™¤å¯¹è±¡
        return self._delete_object_from_external(event)
    
    def _process_sync_event(self, event):
        """å¤„ç†åŒæ­¥äº‹ä»¶"""
        # æ‰§è¡ŒåŒå‘åŒæ­¥
        return self._perform_bidirectional_sync(event)
```

## ğŸ“‹ å®æ–½å»ºè®®

### 1. åˆ†é˜¶æ®µå®æ–½
- **ç¬¬ä¸€é˜¶æ®µ**ï¼šæ·»åŠ åŸºç¡€æ‰©å±•å­—æ®µï¼ˆexternal_id, custom_fieldsç­‰ï¼‰
- **ç¬¬äºŒé˜¶æ®µ**ï¼šå®ç°åŠ¨æ€å­—æ®µç®¡ç†
- **ç¬¬ä¸‰é˜¶æ®µ**ï¼šå»ºç«‹å¤–éƒ¨ç³»ç»Ÿæ˜ å°„
- **ç¬¬å››é˜¶æ®µ**ï¼šå®ç°é…ç½®é©±åŠ¨çš„åŒæ­¥

### 2. æ•°æ®è¿ç§»ç­–ç•¥
```python
# æ•°æ®è¿ç§»ç¤ºä¾‹
def migrate_existing_data():
    """è¿ç§»ç°æœ‰æ•°æ®"""
    # ä¸ºç°æœ‰è®°å½•æ·»åŠ æ‰©å±•å­—æ®µ
    for employee in Employee.objects.all():
        if not hasattr(employee, 'custom_fields'):
            employee.custom_fields = {}
            employee.save()
```

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- å®ç°å­—æ®µå˜æ›´çš„æ‰¹é‡å¤„ç†
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤æŸ¥è¯¢
- å¼‚æ­¥å¤„ç†å¤§é‡æ•°æ®åŒæ­¥

### 4. ç›‘æ§å’Œæ—¥å¿—
```python
class SyncLogger:
    """åŒæ­¥æ—¥å¿—è®°å½•å™¨"""
    
    def log_sync_operation(self, operation, status, details):
        """è®°å½•åŒæ­¥æ“ä½œ"""
        logger.info(f"Sync {operation}: {status}", extra={
            'operation': operation,
            'status': status,
            'details': details,
            'timestamp': timezone.now()
        })
```

## ğŸ¯ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ–¹æ¡ˆï¼Œç»„ç»‡æ¶æ„ä¸­å°ç³»ç»Ÿå¯ä»¥ï¼š

1. **çµæ´»æ‰©å±•**ï¼šæ”¯æŒæœªçŸ¥å­—æ®µçš„åŠ¨æ€æ·»åŠ 
2. **ç³»ç»Ÿé›†æˆ**ï¼šä¸å„ç§ç¬¬ä¸‰æ–¹ç³»ç»Ÿæ— ç¼é›†æˆ
3. **æ•°æ®åŒæ­¥**ï¼šå®ç°å¯é çš„æ•°æ®åŒæ­¥æœºåˆ¶
4. **å†²çªè§£å†³**ï¼šå¤„ç†å¤šç³»ç»Ÿé—´çš„æ•°æ®å†²çª
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¿è¯ç³»ç»Ÿçš„é«˜æ€§èƒ½è¿è¡Œ

è¿™äº›æ–¹æ¡ˆå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œç»„åˆä½¿ç”¨ï¼Œä¸ºç»„ç»‡æ¶æ„ä¸­å°ç³»ç»Ÿæä¾›å¼ºå¤§çš„æ‰©å±•æ€§å’Œé›†æˆèƒ½åŠ›ã€‚
